import { getPackageNameFromFilePath, getPackageNameFromModuleSpecifier } from './modules.js';
import { dirname, isInNodeModules, isInternal } from './path.js';
import { fromBinary, isBinary } from './protocols.js';
import { _resolveSync } from './resolve.js';
export const getReferencedDependencyHandler = (collector, deputy, chief) => (specifier, containingFilePath, workspace) => {
    if (isBinary(specifier)) {
        const binaryName = fromBinary(specifier);
        const isHandled = deputy.maybeAddReferencedBinary(workspace, binaryName);
        if (!isHandled)
            collector.addIssue({
                type: 'binaries',
                filePath: containingFilePath,
                workspace: workspace.name,
                symbol: binaryName,
            });
    }
    else {
        if (isInternal(specifier)) {
            const resolvedFilePath = _resolveSync(specifier, dirname(containingFilePath));
            if (resolvedFilePath)
                return resolvedFilePath;
            collector.addIssue({
                type: 'unresolved',
                filePath: containingFilePath,
                workspace: workspace.name,
                symbol: specifier,
            });
        }
        else {
            const packageName = isInNodeModules(specifier)
                ? getPackageNameFromFilePath(specifier)
                : getPackageNameFromModuleSpecifier(specifier);
            const isHandled = packageName && deputy.maybeAddReferencedExternalDependency(workspace, packageName);
            if (!isHandled)
                collector.addIssue({
                    type: 'unlisted',
                    filePath: containingFilePath,
                    workspace: workspace.name,
                    symbol: specifier,
                });
            if (packageName && specifier !== packageName) {
                const specifierWorkspace = chief.workspacePackagesByPkgName.get(packageName);
                if (specifierWorkspace) {
                    if (specifier.startsWith(packageName)) {
                        const dir = specifier.replace(new RegExp(`^${packageName}`), `./${specifierWorkspace.name}`);
                        const resolvedFilePath = _resolveSync(dir, chief.cwd);
                        if (resolvedFilePath)
                            return resolvedFilePath;
                    }
                    const resolvedFilePath = _resolveSync(specifier, dirname(containingFilePath));
                    if (resolvedFilePath)
                        return resolvedFilePath;
                    collector.addIssue({
                        type: 'unresolved',
                        filePath: containingFilePath,
                        workspace: workspace.name,
                        symbol: specifier,
                    });
                }
            }
        }
    }
};
